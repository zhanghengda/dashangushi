<!--
 * @Author: Tony 31960197+zhanghengda@users.noreply.github.com
 * @Date: 2025-03-25 00:05:17
 * @LastEditors: Tony 31960197+zhanghengda@users.noreply.github.com
 * @LastEditTime: 2025-03-28 12:44:51
 * @FilePath: /undefined/Users/tonyzhang/Documents/GitHub/dashangushi/index.html
 * @Description: 这是默认设置,请设置`customMade`, 打开koroFileHeader查看配置 进行设置: https://github.com/OBKoro1/koro1FileHeader/wiki/%E9%85%8D%E7%BD%AE
-->
<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>大山故事信息系统</title>

    <!-- 引入 Firebase SDK -->

    <style>
      body {
        font-family: Arial, sans-serif;
      }
      #storedData {
        /* margin-top: 20px; */
        font-size: 18px;
      }
    </style>
  </head>
  <body>
    <div class="add-box">
      <h1>大山故事信息系统</h1>

      <div id="bianhao">
        <div class="input-box" id="bianhaoinput">
          <input
            class="inputname"
            type="text"
            id="inputname"
            placeholder="请输入员工编号"
          />
        </div>
        <div class="input-box" id="mima">
          <input
            class="inputname"
            type="password"
            id="inputmima"
            placeholder="请输密码"
          />
        </div>
        <button class="add-btn" id="bianhaobtn">登陆</button>
      </div>

      <div id="shuju" class="shuju">
        <button class="add-btn tuichubtn" id="tuichubtn">退出</button>
        <div class="input-box">
          <input
            class="inputname"
            type="text"
            id="username"
            placeholder="名称"
          />
          <input
            class="inputphone"
            type="text"
            id="userphone"
            placeholder="电话"
          />
        </div>
     

        <button class="add-btn" id="myButton">添加数据</button>
        <!-- <button class="add-btn" id="myButton2">检测是否存在</button> -->
<!-- 
        <div class="itemheader">
          <div class="num" id="num">编号</div>
          <div class="name" id="name">名称</div>
          <div class="phone" id="puone">电话号</div>
          <div class="date" id="date">日期</div>
        </div>
        <div class="data-box" id="storedData"></div> -->
        <table id="myTable">
          <thead>
            <tr>
              <th>编号</th>
              <th>名称</th>
              <th>电话号</th>
              <th>日期</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <img class="headerimg" src="dashangushi.jpg" alt="" />
    </div>

    <script type="module">
      // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-app.js";
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-analytics.js";
      import {
        getDatabase,
        ref,
        set,
        get,
        child,
        onValue,
      } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-database.js";
      // TODO: Add SDKs for Firebase products that you want to use
      // https://firebase.google.com/docs/web/setup#available-libraries

      // Your web app's Firebase configuration
      // For Firebase JS SDK v7.20.0 and later, measurementId is optional
      const firebaseConfig = {
        apiKey: "AIzaSyAiD20QuH2l6FrmJ4iun4g_1no9fUima-4",
        authDomain: "dashangushi.firebaseapp.com",
        projectId: "dashangushi",
        storageBucket: "dashangushi.firebasestorage.app",
        messagingSenderId: "810925226704",
        appId: "1:810925226704:web:76199aabe4cbf1cc137cd5",
        measurementId: "G-0CZHBWD0XF",
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);
      const analytics = getAnalytics(app);

      function getRandom10DigitNumber() {
        return Math.floor(1000000000 + Math.random() * 9000000000);
      }

      function load() {
        let bianhao = localStorage.getItem("bianhaoid");
        if (!bianhao) {
          document.getElementById("shuju").style.display = "none";
          document.getElementById("bianhao").style.display = "";
        } else {
          document.getElementById("shuju").style.display = "";
          document.getElementById("bianhao").style.display = "none";
        }
      }
      function formatTimestamp(timestamp) {
        const date = new Date(timestamp);

        return date.toLocaleString().split(" ")[0]; // 转换为本地时间格式
      }
      // 获取数据库中的数据
      // 读取数据
      async function loadData() {
        const dataRef = ref(db, "users");
        console.log("读取数据", dataRef);

        let snapshot = await get(dataRef)
          .then()
          .catch((error) => {
            console.error("读取数据失败: ", error);
          });

        if (snapshot.exists()) {
          const dataObject = snapshot.val();
          const dataArray = Object.keys(dataObject).map((key) => ({
            id: key,
            ...dataObject[key],
          }));

          let showdata = [];
          if (localStorage.getItem("bianhaoid") == "ds00000") {
            showdata = dataArray;
          } else {
            showdata = dataArray.filter(
              (t) => t.bianhao == localStorage.getItem("bianhaoid")
            );
          }

          console.log("shuju", showdata);
          //   storedData

          // <div class="item">
          //     <div class="num" id="num">001</div>
          //     <div class="name" id="name">张制品</div>
          //     <div class="phone" id="puone">电话号</div>
          //     <div class="date" id="date">137278378728</div>
          //   </div>
          const tbody = document.querySelector("#myTable tbody");

          showdata.forEach((row) => {
            const tr = document.createElement("tr");
            const td = document.createElement("td");
              td.textContent = row.bianhao;
              tr.appendChild(td);

              const td1 = document.createElement("td");
              td1.textContent = row.username;
              tr.appendChild(td1);

              const td2 = document.createElement("td");
              td2.textContent = row.phone;
              tr.appendChild(td2);


              const td3 = document.createElement("td");
              td3.textContent =formatTimestamp(row.date);
              tr.appendChild(td3);

             tbody.appendChild(tr);
          });

        //   const container = document.getElementById("storedData");

        //   container.innerHTML = "";
        //   for (let index = 0; index < showdata.length; index++) {
        //     const element = showdata[index];
        //     let item = document.createElement("item"); // 创建 div
        //     item.className = "item"; // 设置 class
        //     item.id = "item" + index; // 设置 class

        //     let numDiv = document.createElement("div"); // 创建 div
        //     numDiv.className = "num"; // 设置 class
        //     numDiv.id = "num"; // 设置 class
        //     numDiv.textContent = element.bianhao; // 设置

        //     let nameDiv = document.createElement("div"); // 创建 div
        //     nameDiv.className = "name"; // 设置 class
        //     nameDiv.id = "name"; // 设置 class
        //     nameDiv.textContent = element.username; // 设置

        //     let phoneDiv = document.createElement("div"); // 创建 div
        //     phoneDiv.className = "phone"; // 设置 class
        //     phoneDiv.id = "phone"; // 设置 class
        //     phoneDiv.textContent = element.phone; // 设置

        //     let dateDiv = document.createElement("div"); // 创建 div
        //     dateDiv.className = "date"; // 设置 class
        //     dateDiv.id = "date"; // 设置 class
        //     dateDiv.textContent = formatTimestamp(element.date); // 设置
        //     item.appendChild(numDiv); // 添加到容器中
        //     item.appendChild(nameDiv); // 添加到容器中
        //     item.appendChild(phoneDiv); // 添加到容器中
        //     item.appendChild(dateDiv); // 添加到容器中

        //     container.appendChild(item); // 添加到容器中
        //   }

          console.log("数据数组：", dataArray);
        } else {
          //   document.getElementById("storedData").innerText = "没有数据";
        }
      }

      // 保存数据到 管理员 Firebase
      function saveUser(data) {
        let path = "admin/";
        let id = getRandom10DigitNumber();
        const dataRef = ref(db, path + id); // 指定存储路径

        console.log("ssswwwsss", dataRef, data);
        // return
        set(dataRef, data) // 将数据存储到指定路径
          .then(() => {
            console.log("数据已保存！");
          })
          .catch((error) => {
            console.error("保存数据失败: ", error);
          });
      }

      // 登陆
      async function login(data) {
        const dataRef = ref(db, "admin");
        console.log("读取数据", dataRef, data);

        let snapshot = await get(dataRef)
          .then()
          .catch((error) => {
            console.error("读取数据失败: ", error);
          });

        if (snapshot.exists()) {
          const dataObject = snapshot.val();
          const dataArray = Object.keys(dataObject).map((key) => ({
            id: key,
            ...dataObject[key],
          }));
          console.log("数据数组：", dataArray);

          let ishas = dataArray.find(
            (t) => t.bianhao == data.bianhao && t.password == data.password
          );
          if (ishas) {
            document.getElementById("shuju").style.display = "";
            document.getElementById("bianhao").style.display = "none";
            let bianhao = localStorage.setItem("bianhaoid", data.bianhao);
          } else {
            document.getElementById("shuju").style.display = "none";
            document.getElementById("bianhao").style.display = "";
            alert("用户名或密码错误！");
          }
        } else {
          //   document.getElementById("storedData").innerText = "没有数据";
        }
      }

      //检测数据是否存在
      async function isHas(data) {
        const dataRef = ref(db, "users");
        console.log("读取数据", dataRef);

        let snapshot = await get(dataRef)
          .then()
          .catch((error) => {
            console.error("读取数据失败: ", error);
          });

        if (snapshot.exists()) {
          console.log("读取数据", snapshot.val());

          const dataObject = snapshot.val();
          const dataArray = Object.keys(dataObject).map((key) => ({
            id: key,
            ...dataObject[key],
          }));
          console.log("数据数组：", dataArray);

          let ishas = dataArray.filter((t) => t.phone == data.phone);

          console.log("ishas", ishas, ishas.length > 0);

          return ishas.length > 0;
        } else {
          return false;
        }
        return false;
      }
      // 保存数据到 Firebase
      function saveData(data) {
        let path = "users/";
        let id = getRandom10DigitNumber();
        const dataRef = ref(db, path + id); // 指定存储路径

        console.log("ssswwwsss", dataRef, data);

        set(dataRef, data) // 将数据存储到指定路径
          .then(() => {
            console.log("数据已保存！");
            loadData();
          })
          .catch((error) => {
            console.error("保存数据失败: ", error);
          });
      }

      // 获取按钮并添加点击事件监听器
      document.getElementById("myButton").addEventListener("click", () => {
        // 调用导入的函数
        console.log("ssssss");

        let name = document.getElementById("username").value;
        let phone = document.getElementById("userphone").value;
        let data = {
          bianhao: localStorage.getItem("bianhaoid"),
          username: name,
          date: Date.now(),
          phone: phone,
        };

        //检测数据是否存在
        const dataRef = ref(db, "users");
        console.log("读取数据", dataRef);

        get(dataRef)
          .then((snapshot) => {
            if (snapshot.exists()) {
              console.log("读取数据", snapshot.val());

              const dataObject = snapshot.val();
              const dataArray = Object.keys(dataObject).map((key) => ({
                id: key,
                ...dataObject[key],
              }));
              console.log("数据数组：", dataArray);

              let ishas = dataArray.filter((t) => t.phone == data.phone);

              console.log("ishas", ishas, ishas.length > 0);

              let flag = ishas.length > 0;

              if (flag) {
                console.log("shuju", flag);
                alert("用户已存在！");
              } else {
                saveData(data);
              }
            }
          })
          .catch((error) => {
            console.error("读取数据失败: ", error);
          });
      });
      //输入编号
      //   document.getElementById("bianhao").addEventListener("click", () => {
      //     let bianhao = document.getElementById("inputData").value;
      //     localStorage.setItem("bianhao", bianhao);
      //   });

      //添加数据
      document.getElementById("bianhaobtn").addEventListener("click", () => {
        let name = document.getElementById("inputname").value;
        let ps = document.getElementById("inputmima").value;

        let data = {
          bianhao: name,
          password: ps,
        };
        login(data);
        // localStorage.setItem("bianhao", bianhao);
      });
      document.getElementById("tuichubtn").addEventListener("click", () => {
     
        localStorage.removeItem('bianhaoid')

        let bianhao = localStorage.getItem("bianhaoid");
        if (!bianhao) {
          document.getElementById("shuju").style.display = "none";
          document.getElementById("bianhao").style.display = "";
        } else {
          document.getElementById("shuju").style.display = "";
          document.getElementById("bianhao").style.display = "none";
        }
        // localStorage.setItem("bianhao", bianhao);
      });
      
      // 调用方法
      window.onload = function () {
        load();

        loadData(); // 页面加载时读取数据
        // listenForChanges(); // 监听数据变化
      };
      console.log("ssss", analytics, db);
    </script>

    <style>


  .tuichubtn
  {
     position: absolute;
     right: 10px;
     top: 30px;
     z-index: 1;
  }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      th,
      td {
        border: 1px solid black;
        padding: 8px;
        text-align: center;
      }
      .headerimg {
        height: 180px;
      }
      .add-btn {
        margin: 10px;
        width: 200px;
        height: 35px;
        font-size: 16px;
      }
      .inputname {
        width: 200px;
        height: 35px;
        margin-bottom: 10px;
        font-size: 16px;
      }
      .inputphone {
        width: 200px;
        height: 35px;
        font-size: 16px;
      }
      .input-box {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        align-items: center;
      }
      .itemheader {
        display: flex;
        width: 100%;
        margin: 0 auto;
        align-items: center;
        box-sizing: border-box;
        /* justify-content: center; */
        .num {
          width: 20%;
          text-align: center;
        }
        .name {
          width: 20%;
          text-align: center;
        }

        .phone {
          width: 30%;
          text-align: center;
        }
      }
      .data-box {
        display: flex;
        justify-content: flex-start;
        flex-direction: column;
        align-items: center;
        border: 1px solid #000;
        /* padding: 20px 0px; */
        padding-bottom: 10px;
        box-sizing: border-box;

        width: 100%;
        margin: 0 auto;

        height: 400px;
        overflow: scroll;

        .item {
          box-sizing: border-box;
          font-size: 12px;
          width: 100%;
          line-height: 30px;
          height: 30px;
          padding: 0px 10px;
          border-bottom: 1px solid #000;
          display: flex;
          .num {
            border-right: 1px solid #000;
            width: 20%;
            text-align: center;
          }
          .name {
            border-right: 1px solid #000;
            width: 20%;
            text-align: center;
          }

          .phone {
            width: 30%;
            border-right: 1px solid #000;
            text-align: center;
          }
          .date {
          }
        }
      }
      .bianhao {
        width: 100%;
      }
      .shuju {
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
      }
      .add-box {
        display: flex;
        justify-content: center;
        flex-direction: column;
        align-items: center;
        max-width: 90%;
        margin: 0 auto;
      }
    </style>
  </body>
</html>
